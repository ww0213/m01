<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>系統查詢終端</title>
    <style>
        body {
            font-family: 'Courier New', Courier, monospace;
            background-color: #0d0d0d;
            color: #0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            text-shadow: 0 0 5px rgba(0, 255, 0, 0.5);
        }

        .container {
            background-color: #000;
            padding: 2rem;
            border: 2px solid #0f0;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.2);
            width: 100%;
            max-width: 600px;
        }

        h1 {
            text-align: center;
            color: #0f0;
            margin-bottom: 1.5rem;
            border-bottom: 2px dashed #0f0;
            padding-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        h1::before {
            content: "> ";
        }

        h1::after {
            content: "_";
            animation: blink 1s step-end infinite;
        }

        @keyframes blink {
            50% {
                opacity: 0;
            }
        }

        .input-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: #0f0;
            font-weight: bold;
        }

        select {
            width: 100%;
            padding: 10px;
            background-color: #000;
            color: #0f0;
            border: 1px solid #0f0;
            font-family: 'Courier New', Courier, monospace;
            font-size: 16px;
            outline: none;
        }

        button {
            width: 100%;
            padding: 15px;
            background-color: #000;
            color: #0f0;
            border: 2px solid #0f0;
            font-size: 18px;
            font-family: 'Courier New', Courier, monospace;
            font-weight: bold;
            cursor: pointer;
            text-transform: uppercase;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        button:hover {
            background-color: #0f0;
            color: #000;
            box-shadow: 0 0 25px #0f0;
        }

        button:disabled {
            border-color: #555;
            color: #555;
            cursor: not-allowed;
            box-shadow: none;
        }

        #gpsBtn::before {
            content: "☁";
            position: absolute;
            left: 20px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        #gpsBtn:hover::before {
            opacity: 1;
        }

        #result {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px dashed #0f0;
            min-height: 100px;
        }

        .location-badge {
            text-align: center;
            font-size: 1.2rem;
            border: 1px solid #0f0;
            padding: 10px;
            margin-bottom: 20px;
            background: #001a00;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.2);
        }

        .weather-card {
            background: #000;
            border: 1px solid #0f0;
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
        }

        .weather-card::before {
            content: "[DATA STREAM]";
            position: absolute;
            top: -10px;
            left: 10px;
            background: #000;
            padding: 0 5px;
            font-size: 0.8rem;
            color: #0f0;
        }

        .weather-card h3 {
            margin-top: 0;
            color: #0f0;
            border-bottom: 1px solid #003300;
            padding-bottom: 5px;
            font-size: 1.1rem;
        }

        .weather-item {
            margin: 8px 0;
            display: flex;
            justify-content: space-between;
            border-bottom: 1px dotted #003300;
            padding-bottom: 2px;
        }

        .weather-item span {
            color: #00cc00;
        }

        .weather-item strong {
            color: #0f0;
        }

        .error {
            color: #ff3333;
            border: 1px solid #ff3333;
            padding: 10px;
            text-align: center;
            text-shadow: 0 0 5px rgba(255, 0, 0, 0.5);
        }

        .loading {
            text-align: center;
            color: #0f0;
            font-family: 'Courier New', Courier, monospace;
            margin-top: 20px;
        }

        .loading::after {
            content: "";
            animation: typingDots 1.5s steps(4, end) infinite;
        }

        @keyframes typingDots {

            0%,
            20% {
                content: "";
            }

            40% {
                content: ".";
            }

            60% {
                content: "..";
            }

            80%,
            100% {
                content: "...";
            }
        }

        /* Tabs */
        .nav-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #0f0;
        }

        .nav-btn {
            flex: 1;
            background: #000;
            color: #0f0;
            border: none;
            padding: 10px;
            cursor: pointer;
            font-family: 'Courier New', Courier, monospace;
            font-weight: bold;
            font-size: 1.1rem;
            opacity: 0.6;
            transition: all 0.3s;
            box-shadow: none;
        }

        .nav-btn:hover {
            background: #003300;
            opacity: 1;
            box-shadow: none;
        }

        .nav-btn.active {
            background: #0f0;
            color: #000;
            opacity: 1;
        }

        .section-content {
            display: none;
            animation: fadeIn 0.5s;
        }

        .section-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .stars {
            color: #ffff00;
            text-shadow: 0 0 8px #ffff00;
            letter-spacing: 2px;
        }

        .stars-empty {
            color: #003300;
            letter-spacing: 2px;
        }

        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #000;
        }

        ::-webkit-scrollbar-thumb {
            background: #0f0;
            border: 1px solid #000;
        }
    </style>
</head>

<body>

    <div class="container">
        <h1>系統查詢終端</h1>

        <div class="nav-tabs">
            <button class="nav-btn active" onclick="switchTab('weather')">天氣掃描 (SCAN)</button>
            <button class="nav-btn" onclick="switchTab('horoscope')">運勢演算 (FATE)</button>
        </div>

        <!-- 天氣區塊 -->
        <div id="weatherSection" class="section-content active">
            <p style="text-align: center; margin-bottom: 20px; color: #00cc00;">
                [INFO] 請點擊下方按鈕以啟動衛星定位與氣象分析模組。
            </p>

            <button id="gpsBtn">啟動 GPS 定位掃描</button>
        </div>

        <!-- 運勢區塊 -->
        <div id="horoscopeSection" class="section-content">
            <div class="input-group">
                <label for="zodiac">星體校準 (ZODIAC)</label>
                <select id="zodiac">
                    <option value="0">牡羊座 (Aries)</option>
                    <option value="1">金牛座 (Taurus)</option>
                    <option value="2">雙子座 (Gemini)</option>
                    <option value="3">巨蟹座 (Cancer)</option>
                    <option value="4">獅子座 (Leo)</option>
                    <option value="5">處女座 (Virgo)</option>
                    <option value="6">天秤座 (Libra)</option>
                    <option value="7">天蠍座 (Scorpio)</option>
                    <option value="8">射手座 (Sagittarius)</option>
                    <option value="9">摩羯座 (Capricorn)</option>
                    <option value="10">水瓶座 (Aquarius)</option>
                    <option value="11">雙魚座 (Pisces)</option>
                </select>
            </div>
            <button id="fateBtn">執行運勢運算</button>
        </div>

        <div id="result"></div>
    </div>

    <script>
        const gpsBtn = document.getElementById('gpsBtn');
        const fateBtn = document.getElementById('fateBtn');
        const resultDiv = document.getElementById('result');

        gpsBtn.addEventListener('click', startGPSScan);
        fateBtn.addEventListener('click', generateFortune);

        function switchTab(tabName) {
            document.querySelectorAll('.section-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));

            if (tabName === 'weather') {
                document.getElementById('weatherSection').classList.add('active');
                document.querySelectorAll('.nav-btn')[0].classList.add('active');
            } else {
                document.getElementById('horoscopeSection').classList.add('active');
                document.querySelectorAll('.nav-btn')[1].classList.add('active');
            }
            resultDiv.innerHTML = '';
        }

        // --- GPS Logic ---
        function startGPSScan() {
            if (!navigator.geolocation) {
                showError("錯誤: 此裝置不支援定位功能 (Geolocation not supported)");
                return;
            }

            resultDiv.innerHTML = '<div class="loading">正在三角定位目前位置</div>';
            gpsBtn.disabled = true;

            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;

                    try {
                        // Parallel Fetch: Location Name + Weather Data
                        resultDiv.innerHTML = '<div class="loading">位置已鎖定。正在下載環境數據</div>';

                        const [locationName, weatherData] = await Promise.all([
                            fetchLocationName(lat, lon),
                            fetchWeatherData(lat, lon)
                        ]);

                        displayDashboard(locationName, weatherData);

                    } catch (err) {
                        showError("數據下載失敗: " + err.message);
                    } finally {
                        gpsBtn.disabled = false;
                        gpsBtn.textContent = "重新掃描位置 (RE-SCAN)";
                    }
                },
                (error) => {
                    let msg = "定位訊號遺失";
                    if (error.code === 1) msg = "使用者拒絕提供位置權限";
                    showError(msg);
                    gpsBtn.disabled = false;
                }
            );
        }

        // --- BigDataCloud API 取得位置名稱 ---
        async function fetchLocationName(lat, lon) {
            const url = `https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=zh`;
            const res = await fetch(url);
            if (!res.ok) throw new Error("Location Service Error");
            const data = await res.json();

            // 組合地址名稱
            let name = data.locality || data.city || data.principalSubdivision || "未知區域 (Unknown Area)";

            if (data.principalSubdivision && !name.includes(data.principalSubdivision)) {
                name = `${data.principalSubdivision} ${name}`;
            }
            return name;
        }


        async function fetchWeatherData(lat, lon) {
            // 天氣 API
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=weathercode,temperature_2m_max,temperature_2m_min,precipitation_probability_max&current_weather=true&timezone=auto`;
            const res = await fetch(url);
            if (!res.ok) throw new Error("Weather Satellite Error");
            return await res.json();
        }

        function displayDashboard(locationName, data) {
            const current = data.current_weather;
            const daily = data.daily;

            // 參考天氣預報濕度給予描述
            const wmoToText = (code) => {
                const map = {
                    0: "晴朗 (Clear)", 1: "大致晴朗 (Mainly Clear)", 2: "多雲 (Partly Cloudy)", 3: "陰天 (Overcast)",
                    45: "霧 (Fog)", 48: "霧 (Fog)",
                    51: "毛毛雨 (Drizzle)", 53: "毛毛雨", 55: "毛毛雨",
                    61: "小雨 (Rain Slight)", 63: "中雨 (Rain Mod.)", 65: "大雨 (Rain Heavy)",
                    80: "陣雨 (Showers)", 81: "陣雨", 82: "強陣雨",
                    95: "雷雨 (Thunderstorm)", 96: "雷雨伴隨冰雹", 99: "大雷雨"
                };
                return map[code] || `未知代碼 (${code})`;
            };

            // 參考天氣預報天氣給予描述
            const getComfort = (t) => {
                if (t >= 30) return "酷熱 (Hot)";
                if (t >= 26) return "悶熱 (Warm)";
                if (t >= 20) return "舒適 (Comfortable)";
                if (t >= 15) return "稍涼 (Cool)";
                return "寒冷 (Cold)";
            };

            let html = `
            <div class="location-badge">
                偵測座標: ${locationName}
            </div>
            <h2>環境數據分析報告</h2>
        `;

            // 現在天氣區塊
            html += `
            <div class="weather-card" style="border-color: #ffff00; box-shadow: 0 0 10px rgba(255,255,0,0.1);">
                <h3 style="color: #ffff00; border-bottom-color: #666600;"> 即時現況 (LIVE)</h3>
                <div class="weather-item">
                    <span>天氣現象 (Wx)：</span>
                    <strong style="font-size:1.2rem;">${wmoToText(current.weathercode)}</strong>
                </div>
                <div class="weather-item">
                    <span>環境溫度 (Temp)：</span>
                    <strong style="font-size:1.2rem;">${current.temperature}°C</strong>
                </div>
                <div class="weather-item">
                    <span>體感評估 (Feel)：</span>
                    <strong>${getComfort(current.temperature)}</strong>
                </div>
                <div class="weather-item">
                    <span>風速流動 (Wind)：</span>
                    <strong>${current.windspeed} km/h</strong>
                </div>
            </div>
        `;

            // 未來天氣區塊
            html += `<h3> 未來預測 (FORECAST)</h3>`;
            for (let i = 0; i < 3; i++) { // Show 3 days
                const date = new Date(daily.time[i]).toLocaleDateString('zh-TW', { month: 'numeric', day: 'numeric', weekday: 'short' });
                html += `
                <div class="weather-card">
                    <h3> ${date}</h3>
                    <div class="weather-item">
                        <span>預測天氣：</span>
                        <strong>${wmoToText(daily.weathercode[i])}</strong>
                    </div>
                    <div class="weather-item">
                        <span>氣溫範圍：</span>
                        <strong>${daily.temperature_2m_min[i]}°C - ${daily.temperature_2m_max[i]}°C</strong>
                    </div>
                    <div class="weather-item">
                        <span>降雨機率：</span>
                        <strong>${daily.precipitation_probability_max[i] || 0}%</strong>
                    </div>
                </div>
            `;
            }

            resultDiv.innerHTML = html;
        }

        function showError(msg) {
            resultDiv.innerHTML = `<div class="error"> SYSTEM ERROR: ${msg}</div>`;
        }

        // --- 運勢 Logic ---
        function generateFortune() {
            const zodiacIndex = parseInt(document.getElementById('zodiac').value);
            const zodiacNames = ["牡羊", "金牛", "雙子", "巨蟹", "獅子", "處女", "天秤", "天蠍", "射手", "摩羯", "水瓶", "雙魚"];
            const today = new Date();
            const dateStr = today.getFullYear() * 10000 + (today.getMonth() + 1) * 100 + today.getDate();
            const seed = dateStr + zodiacIndex;
            const random = (offset = 0) => {
                let x = Math.sin(seed + offset) * 10000;
                return x - Math.floor(x);
            };
            const getScore = (offset) => Math.floor(random(offset) * 5) + 1;
            const pick = (arr, offset) => arr[Math.floor(random(offset) * arr.length)];
            const colors = ["矩陣綠", "錯誤紅", "深空黑", "乙太藍", "量子金", "光纖白", "警告橘", "虛擬紫"];
            const numbers = [0, 1, 3, 5, 7, 8, 9, 11, 42, 101, 404, 500];
            const advicePool = [
                "系統運行穩定，適合執行重大決策。",
                "防火牆偵測到潛在風險，請保守行事。",
                "連結訊號強烈，適合社交與溝通。",
                "記憶體佔用過高，請讓大腦適度休息。",
                "發現未預期的 Bug，請小心處理細節。",
                "雲端同步順利，你的想法會被看見。",
                "今日適合重構生活模式。",
                "不要忽略警告日誌，直覺是對的。",
                "流量高峰期，請避免情緒過載。",
                "加密金鑰已更新，安全感提升。"
            ];

            const overall = getScore(1);
            const love = getScore(2);
            const work = getScore(3);
            const money = getScore(4);
            const luckyColor = pick(colors, 5);
            const luckyNumber = pick(numbers, 6);
            const advice = pick(advicePool, 7);

            const renderStars = (n) => `<span class="stars">${'★'.repeat(n)}</span><span class="stars-empty">${'☆'.repeat(5 - n)}</span>`;

            fateBtn.disabled = true;
            resultDiv.innerHTML = '<div class="loading">正在解析命運矩陣</div>';

            setTimeout(() => {
                let html = `<h2> ${zodiacNames[zodiacIndex]}座 今日運算</h2>`;
                html += `
                <div class="weather-card">
                    <h3> Date: ${today.toLocaleDateString()}</h3>
                    <div class="weather-item"><span>整體運勢：</span><strong>${renderStars(overall)}</strong></div>
                    <div class="weather-item"><span>感情連結：</span><strong>${renderStars(love)}</strong></div>
                    <div class="weather-item"><span>工作效能：</span><strong>${renderStars(work)}</strong></div>
                    <div class="weather-item"><span>財富數據：</span><strong>${renderStars(money)}</strong></div>
                    <div class="weather-item"><span>幸運色：</span><strong>${luckyColor}</strong></div>
                    <div class="weather-item"><span>幸運數：</span><strong>${luckyNumber}</strong></div>
                    <div class="weather-item" style="border-top: 1px dashed #0f0; margin-top:10px; padding-top:10px;">
                        <span>系統建議：</span>
                    </div>
                    <div style="color: #0f0; margin-top:5px; font-weight:bold;">> ${advice}</div>
                </div>
            `;
                resultDiv.innerHTML = html;
                fateBtn.disabled = false;
            }, 800);
        }
    </script>

</body>

</html>
